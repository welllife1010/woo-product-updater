<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Woo Product Updater</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f9fafb; color: #374151; line-height: 1.6; }
    .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
    h1 { font-size: 1.875rem; font-weight: 700; color: #111827; margin-bottom: 8px; }
    .subtitle { color: #6b7280; margin-bottom: 32px; }
    .card { background: white; border-radius: 8px; border: 1px solid #e5e7eb; padding: 24px; margin-bottom: 24px; }
    .card h2 { font-size: 1.25rem; font-weight: 600; color: #1f2937; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid #f3f4f6; }
    .form-group { margin-bottom: 16px; }
    label { display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 8px; }
    input, select { width: 100%; padding: 12px; font-size: 1rem; border: 1px solid #d1d5db; border-radius: 6px; }
    input:focus, select:focus { outline: none; border-color: #2563eb; box-shadow: 0 0 0 3px #dbeafe; }
    .help { font-size: 0.875rem; color: #6b7280; margin-top: 4px; }
    .btn { display: inline-flex; align-items: center; gap: 8px; padding: 12px 20px; font-size: 0.875rem; font-weight: 500; border: none; border-radius: 6px; cursor: pointer; }
    .btn-primary { background: #2563eb; color: white; }
    .btn-primary:hover { background: #1d4ed8; }
    .btn-secondary { background: white; color: #374151; border: 1px solid #d1d5db; }
    .btn-secondary:hover { background: #f9fafb; }
    .btn-success { background: #059669; color: white; }
    .btn-sm { padding: 8px 12px; font-size: 0.75rem; }
    table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
    th { background: #f9fafb; padding: 12px; text-align: left; font-weight: 600; color: #4b5563; text-transform: uppercase; font-size: 0.75rem; border-bottom: 1px solid #e5e7eb; }
    td { padding: 16px 12px; border-bottom: 1px solid #f3f4f6; }
    tr:hover { background: #f9fafb; }
    .file-key { font-family: monospace; font-size: 0.75rem; word-break: break-all; }
    .badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 12px; font-size: 0.75rem; font-weight: 600; border-radius: 9999px; text-transform: uppercase; }
    .badge-pending { background: #fef3c7; color: #d97706; }
    .badge-ready { background: #d1fae5; color: #059669; }
    .badge::before { content: ''; width: 6px; height: 6px; border-radius: 50%; background: currentColor; }
    .empty { text-align: center; padding: 48px; color: #6b7280; }
    .toast-container { position: fixed; top: 24px; right: 24px; z-index: 1000; }
    .toast { display: flex; gap: 12px; padding: 16px; background: white; border-radius: 8px; box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1); border-left: 4px solid #6b7280; margin-bottom: 12px; max-width: 400px; }
    .toast-success { border-left-color: #059669; }
    .toast-error { border-left-color: #dc2626; }
    .toast-title { font-weight: 600; color: #1f2937; }
    .toast-message { font-size: 0.875rem; color: #4b5563; }
    .spinner { width: 16px; height: 16px; border: 2px solid transparent; border-top-color: currentColor; border-radius: 50%; animation: spin 0.6s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .mapping-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .mapping-field { background: #f9fafb; padding: 16px; border-radius: 6px; border: 1px solid #e5e7eb; }
    .mapping-actions { display: flex; gap: 12px; justify-content: flex-end; padding-top: 16px; border-top: 1px solid #e5e7eb; }
  </style>
</head>
<body>
  <div id="toast-container" class="toast-container"></div>
  <div class="container">
    <h1>CSV Column Mapping</h1>
    <p class="subtitle">Upload CSV files and configure column mappings for the WooCommerce product updater.</p>

    <div class="card">
      <h2>Upload CSV File</h2>
      <form id="upload-form">
        <div class="form-group">
          <label for="file">CSV File *</label>
          <input type="file" id="file" name="file" accept=".csv" required>
          <p class="help">Upload a CSV file containing product data.</p>
        </div>
        <div class="form-group">
          <label for="folder">S3 Folder (Optional)</label>
          <input type="text" id="folder" name="folder" placeholder="e.g., vendor-uploads/2025/">
          <p class="help">Optional S3 folder path.</p>
        </div>
        <button type="submit" id="upload-btn" class="btn btn-primary">Upload to S3</button>
      </form>
    </div>

    <div class="card">
      <h2 style="display: flex; justify-content: space-between; align-items: center;">
        Registered Files
        <button id="refresh-btn" class="btn btn-secondary btn-sm">Refresh</button>
      </h2>
      <div id="files-wrapper"><div class="empty"><p>Loading...</p></div></div>
    </div>

    <div id="mapping-container"></div>
  </div>

  <script>
    function showToast(msg, type) {
      var c = document.getElementById('toast-container');
      var t = document.createElement('div');
      t.className = 'toast toast-' + type;
      t.innerHTML = '<div><div class="toast-title">' + (type === 'success' ? 'Success' : type === 'error' ? 'Error' : 'Info') + '</div><div class="toast-message">' + msg + '</div></div>';
      c.appendChild(t);
      setTimeout(function() { t.remove(); }, 5000);
    }

    function setLoading(btn, loading) {
      if (loading) { btn.disabled = true; btn.dataset.orig = btn.innerHTML; btn.innerHTML = '<span class="spinner"></span> Loading...'; }
      else { btn.disabled = false; btn.innerHTML = btn.dataset.orig; }
    }

    function escapeHtml(t) { var d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
    function escapeJs(t) { return String(t||'').replace(/\\/g,'\\\\').replace(/'/g,"\\'").replace(/"/g,'\\"'); }

    async function fetchFiles() {
      try {
        var r = await fetch('/api/csv-mappings');
        return r.ok ? await r.json() : [];
      } catch (e) { showToast('Failed to load files', 'error'); return []; }
    }

    function renderFiles(files) {
      var w = document.getElementById('files-wrapper');
      if (!files || !files.length) { w.innerHTML = '<div class="empty"><p>No files registered yet. Upload a CSV file to get started.</p></div>'; return; }
      var h = '<table><thead><tr><th>File Key</th><th>Status</th><th>Uploaded</th><th style="text-align:right">Actions</th></tr></thead><tbody>';
      files.forEach(function(f) {
        var d = f.uploadedAt ? new Date(f.uploadedAt).toLocaleDateString() : '-';
        h += '<tr><td class="file-key">' + escapeHtml(f.fileKey) + '</td><td><span class="badge badge-' + f.status + '">' + f.status + '</span></td><td>' + d + '</td><td style="text-align:right"><button class="btn btn-secondary btn-sm" onclick="loadMapping(\'' + escapeJs(f.fileKey) + '\')">Configure</button></td></tr>';
      });
      w.innerHTML = h + '</tbody></table>';
    }

    async function loadMapping(fileKey) {
      try {
        var r = await fetch('/api/csv-mappings/' + encodeURIComponent(fileKey));
        if (!r.ok) throw new Error();
        var data = await r.json();
        var c = document.getElementById('mapping-container');
        var opts = '<option value="">-- Select --</option>' + (data.headers||[]).map(function(h) { return '<option value="' + escapeHtml(h) + '">' + escapeHtml(h) + '</option>'; }).join('');
        c.innerHTML = '<div class="card"><h2>Configure Mapping: ' + escapeHtml(fileKey) + '</h2><form id="mapping-form"><div class="mapping-grid"><div class="mapping-field"><label>Part Number</label><select id="m-partNumber" required>' + opts + '</select></div><div class="mapping-field"><label>Category</label><select id="m-category" required>' + opts + '</select></div><div class="mapping-field"><label>Manufacturer</label><select id="m-manufacturer" required>' + opts + '</select></div></div><div class="mapping-actions"><button type="button" class="btn btn-secondary" onclick="closeMapping()">Cancel</button><button type="submit" id="save-btn" class="btn btn-success">Save Mapping</button></div></form></div>';
        c.dataset.fileKey = fileKey;
        if (data.mapping) {
          if (data.mapping.partNumber) document.getElementById('m-partNumber').value = data.mapping.partNumber;
          if (data.mapping.category) document.getElementById('m-category').value = data.mapping.category;
          if (data.mapping.manufacturer) document.getElementById('m-manufacturer').value = data.mapping.manufacturer;
        }
        document.getElementById('mapping-form').onsubmit = saveMapping;
      } catch (e) { showToast('Failed to load mapping', 'error'); }
    }

    function closeMapping() { document.getElementById('mapping-container').innerHTML = ''; }

    async function saveMapping(e) {
      e.preventDefault();
      var btn = document.getElementById('save-btn');
      var fileKey = document.getElementById('mapping-container').dataset.fileKey;
      var payload = { partNumber: document.getElementById('m-partNumber').value, category: document.getElementById('m-category').value, manufacturer: document.getElementById('m-manufacturer').value };
      if (!payload.partNumber || !payload.category || !payload.manufacturer) { showToast('Please select all fields', 'error'); return; }
      setLoading(btn, true);
      try {
        var r = await fetch('/api/csv-mappings/' + encodeURIComponent(fileKey), { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        if (!r.ok) throw new Error();
        showToast('Mapping saved!', 'success');
        closeMapping();
        renderFiles(await fetchFiles());
      } catch (e) { showToast('Failed to save', 'error'); }
      setLoading(btn, false);
    }

    document.getElementById('upload-form').onsubmit = async function(e) {
      e.preventDefault();
      var btn = document.getElementById('upload-btn');
      var file = document.getElementById('file').files[0];
      if (!file) { showToast('Select a file', 'error'); return; }
      setLoading(btn, true);
      try {
        var fd = new FormData();
        fd.append('file', file);
        var folder = document.getElementById('folder').value.trim();
        if (folder) fd.append('folder', folder);
        var r = await fetch('/api/upload-csv', { method: 'POST', body: fd });
        if (!r.ok) throw new Error();
        var data = await r.json();
        showToast('Uploaded: ' + data.fileKey, 'success');
        document.getElementById('file').value = '';
        document.getElementById('folder').value = '';
        renderFiles(await fetchFiles());
      } catch (e) { showToast('Upload failed', 'error'); }
      setLoading(btn, false);
    };

    document.getElementById('refresh-btn').onclick = async function() {
      setLoading(this, true);
      renderFiles(await fetchFiles());
      setLoading(this, false);
    };

    fetchFiles().then(renderFiles);
  </script>
</body>
</html>
