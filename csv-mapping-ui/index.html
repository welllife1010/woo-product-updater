<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Woo Product Updater</title>
  <style>
    :root {
      --color-primary: #3b82f6;
      --color-success: #22c55e;
      --color-warning: #f59e0b;
      --color-danger: #ef4444;
      --color-purple: #8b5cf6;
      --color-gray-50: #f9fafb;
      --color-gray-100: #f3f4f6;
      --color-gray-200: #e5e7eb;
      --color-gray-300: #d1d5db;
      --color-gray-400: #9ca3af;
      --color-gray-500: #6b7280;
      --color-gray-600: #4b5563;
      --color-gray-700: #374151;
      --color-gray-800: #1f2937;
      --color-gray-900: #111827;
      --radius-sm: 4px;
      --radius-md: 6px;
      --radius-lg: 8px;
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-6: 24px;
      --space-8: 32px;
      --font-mono: 'SF Mono', Monaco, 'Cascadia Code', monospace;
      --text-xs: 11px;
      --text-sm: 13px;
      --text-base: 14px;
      --text-lg: 16px;
      
      /* Environment colors */
      --env-prod-bg: #fef2f2;
      --env-prod-border: #fecaca;
      --env-prod-text: #dc2626;
      --env-staging-bg: #fefce8;
      --env-staging-border: #fef08a;
      --env-staging-text: #ca8a04;
      --env-dev-bg: #f0fdf4;
      --env-dev-border: #bbf7d0;
      --env-dev-text: #16a34a;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--color-gray-50); color: var(--color-gray-800); font-size: var(--text-base); line-height: 1.5; }
    .container { max-width: 1400px; margin: 0 auto; padding: var(--space-6); }
    
    /* Environment Badge Styles */
    .env-badge { display: inline-flex; align-items: center; gap: var(--space-2); padding: var(--space-2) var(--space-4); border-radius: var(--radius-lg); font-weight: 700; font-size: var(--text-sm); text-transform: uppercase; letter-spacing: 0.5px; }
    .env-badge.prod { background: var(--env-prod-bg); border: 2px solid var(--env-prod-border); color: var(--env-prod-text); }
    .env-badge.staging { background: var(--env-staging-bg); border: 2px solid var(--env-staging-border); color: var(--env-staging-text); }
    .env-badge.dev { background: var(--env-dev-bg); border: 2px solid var(--env-dev-border); color: var(--env-dev-text); }
    .env-badge .env-dot { width: 10px; height: 10px; border-radius: 50%; animation: pulse 2s infinite; }
    .env-badge.prod .env-dot { background: var(--env-prod-text); }
    .env-badge.staging .env-dot { background: var(--env-staging-text); }
    .env-badge.dev .env-dot { background: var(--env-dev-text); }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    
    /* Environment Banner */
    .env-banner { padding: var(--space-3) var(--space-4); margin-bottom: var(--space-4); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: space-between; }
    .env-banner.prod { background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%); border: 1px solid var(--env-prod-border); }
    .env-banner.staging { background: linear-gradient(135deg, #fefce8 0%, #fef9c3 100%); border: 1px solid var(--env-staging-border); }
    .env-banner.dev { background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 1px solid var(--env-dev-border); }
    .env-banner-info { display: flex; align-items: center; gap: var(--space-4); }
    .env-banner-details { font-size: var(--text-sm); color: var(--color-gray-600); }
    .env-banner-details strong { color: var(--color-gray-800); }
    
    /* Header */
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-6); padding-bottom: var(--space-4); border-bottom: 1px solid var(--color-gray-200); }
    .page-header-left h1 { font-size: 24px; font-weight: 700; color: var(--color-gray-900); display: flex; align-items: center; gap: var(--space-3); }
    .page-header-left p { color: var(--color-gray-500); font-size: var(--text-sm); margin-top: var(--space-1); }
    .page-header-right { display: flex; gap: var(--space-3); align-items: center; }
    
    /* Cards */
    .card { background: white; border-radius: var(--radius-lg); box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: var(--space-4); overflow: hidden; }
    .card-header { padding: var(--space-4); border-bottom: 1px solid var(--color-gray-100); display: flex; justify-content: space-between; align-items: center; }
    .card-header h2 { font-size: var(--text-lg); font-weight: 600; }
    
    /* Buttons */
    .btn { display: inline-flex; align-items: center; gap: var(--space-2); padding: var(--space-2) var(--space-4); font-size: var(--text-sm); font-weight: 500; border: none; border-radius: var(--radius-md); cursor: pointer; transition: all 0.15s; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: var(--color-primary); color: white; }
    .btn-primary:hover:not(:disabled) { background: #2563eb; }
    .btn-success { background: var(--color-success); color: white; }
    .btn-success:hover:not(:disabled) { background: #16a34a; }
    .btn-secondary { background: var(--color-gray-100); color: var(--color-gray-700); }
    .btn-secondary:hover:not(:disabled) { background: var(--color-gray-200); }
    .btn-danger { background: var(--color-danger); color: white; }
    .btn-danger:hover:not(:disabled) { background: #dc2626; }
    .btn-purple { background: var(--color-purple); color: white; }
    .btn-purple:hover:not(:disabled) { background: #7c3aed; }
    .btn-xs { padding: var(--space-1) var(--space-2); font-size: var(--text-xs); }
    .btn-sm { padding: var(--space-1) var(--space-3); font-size: var(--text-xs); }
    
    /* Forms */
    .form-group { margin-bottom: var(--space-4); }
    .form-label { display: block; font-size: var(--text-sm); font-weight: 500; margin-bottom: var(--space-1); color: var(--color-gray-700); }
    .form-input, .form-select { width: 100%; padding: var(--space-2) var(--space-3); font-size: var(--text-sm); border: 1px solid var(--color-gray-300); border-radius: var(--radius-md); background: white; }
    .form-input:focus, .form-select:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    .form-help { font-size: var(--text-xs); color: var(--color-gray-500); margin-top: var(--space-1); }
    
    /* Log Viewer */
    .log-viewer { background: var(--color-gray-900); border-radius: var(--radius-lg); overflow: hidden; }
    .log-viewer-header { display: flex; justify-content: space-between; align-items: center; padding: var(--space-3) var(--space-4); background: var(--color-gray-800); border-bottom: 1px solid var(--color-gray-700); flex-wrap: wrap; gap: var(--space-2); }
    .log-viewer-title { font-size: var(--text-sm); font-weight: 600; color: white; display: flex; align-items: center; gap: var(--space-2); }
    .log-viewer-controls { display: flex; gap: var(--space-2); align-items: center; flex-wrap: wrap; }
    .log-viewer-body { height: 350px; overflow-y: auto; padding: var(--space-3); font-family: var(--font-mono); font-size: 11px; line-height: 1.6; }
    .log-line { color: var(--color-gray-300); padding: 2px 0; border-bottom: 1px solid var(--color-gray-800); }
    .log-line:hover { background: var(--color-gray-800); }
    .log-line.log-error { color: #f87171; }
    .log-line.log-success { color: #4ade80; }
    .log-line.log-warning { color: #fbbf24; }
    .log-line.log-info { color: #60a5fa; }
    .log-line .env-tag { font-weight: bold; padding: 1px 4px; border-radius: 3px; margin-right: 4px; }
    .log-line .env-tag.prod { background: rgba(220, 38, 38, 0.2); color: #fca5a5; }
    .log-line .env-tag.staging { background: rgba(202, 138, 4, 0.2); color: #fde047; }
    .log-line .env-tag.dev { background: rgba(22, 163, 74, 0.2); color: #86efac; }
    .log-status { display: inline-flex; align-items: center; gap: 6px; font-size: var(--text-xs); color: var(--color-gray-400); }
    .log-status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--color-success); animation: pulse 1s infinite; }
    .log-status-dot.paused { background: var(--color-gray-500); animation: none; }
    
    /* Admin Panel */
    .admin-panel { background: linear-gradient(135deg, #1e3a5f 0%, #2d1b4e 100%); border-radius: var(--radius-lg); padding: var(--space-4); margin-bottom: var(--space-4); }
    .admin-panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-3); }
    .admin-panel-title { font-size: var(--text-sm); font-weight: 600; color: white; }
    .admin-panel-actions { display: flex; gap: var(--space-2); flex-wrap: wrap; }
    .admin-btn { padding: var(--space-2) var(--space-3); font-size: 11px; font-weight: 600; border: none; border-radius: var(--radius-md); cursor: pointer; transition: all 0.15s; }
    .admin-btn-yellow { background: #fbbf24; color: #1f2937; }
    .admin-btn-orange { background: #f97316; color: white; }
    .admin-btn-red { background: #ef4444; color: white; }
    .admin-btn-purple { background: #8b5cf6; color: white; }
    .admin-status { font-size: var(--text-xs); color: rgba(255,255,255,0.7); margin-top: var(--space-2); }
    
    /* Stats Grid */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: var(--space-3); padding: var(--space-4); }
    .stat-item { text-align: center; }
    .stat-value { font-size: 20px; font-weight: 700; color: var(--color-gray-900); }
    .stat-label { font-size: var(--text-xs); color: var(--color-gray-500); margin-top: 2px; }
    
    /* Toast */
    .toast-container { position: fixed; top: var(--space-4); right: var(--space-4); z-index: 1000; display: flex; flex-direction: column; gap: var(--space-2); }
    .toast { padding: var(--space-3) var(--space-4); border-radius: var(--radius-md); color: white; font-size: var(--text-sm); display: flex; align-items: center; gap: var(--space-2); animation: slideIn 0.3s; min-width: 280px; }
    .toast.success { background: var(--color-success); }
    .toast.error { background: var(--color-danger); }
    .toast.warning { background: var(--color-warning); }
    .toast.info { background: var(--color-primary); }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    
    /* Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1001; }
    .modal { background: white; border-radius: var(--radius-lg); max-width: 400px; width: 90%; padding: var(--space-6); }
    .modal-title { font-size: var(--text-lg); font-weight: 600; margin-bottom: var(--space-3); }
    .modal-body { color: var(--color-gray-600); margin-bottom: var(--space-4); }
    .modal-actions { display: flex; justify-content: flex-end; gap: var(--space-2); }
    
    /* Loading */
    .loading { position: relative; pointer-events: none; }
    .loading::after { content: ''; position: absolute; top: 50%; left: 50%; width: 16px; height: 16px; margin: -8px 0 0 -8px; border: 2px solid transparent; border-top-color: currentColor; border-radius: 50%; animation: spin 0.6s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Layout */
    .main-layout { display: grid; grid-template-columns: 1fr 420px; gap: var(--space-6); }
    @media (max-width: 1200px) { .main-layout { grid-template-columns: 1fr; } }
    
    /* File List */
    .file-list { padding: var(--space-4); }
    .file-item { display: flex; justify-content: space-between; align-items: center; padding: var(--space-3); border: 1px solid var(--color-gray-200); border-radius: var(--radius-md); margin-bottom: var(--space-2); }
    .file-info { flex: 1; }
    .file-name { font-weight: 500; font-size: var(--text-sm); }
    .file-status { font-size: var(--text-xs); margin-top: 2px; }
    .file-actions { display: flex; gap: var(--space-2); }
    
    /* Status badges */
    .status-badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: var(--text-xs); font-weight: 500; }
    .status-pending { background: var(--color-gray-100); color: var(--color-gray-600); }
    .status-ready { background: #dbeafe; color: #1d4ed8; }
    .status-processing { background: #fef3c7; color: #b45309; }
    .status-completed { background: #dcfce7; color: #15803d; }
    
    /* Upload form */
    #upload-form { padding: var(--space-4); }
    
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="toast-container" id="toast-container"></div>
  
  <div class="container">
    <!-- Environment Banner -->
    <div class="env-banner" id="env-banner">
      <div class="env-banner-info">
        <div class="env-badge" id="env-badge">
          <span class="env-dot"></span>
          <span id="env-label">Loading...</span>
        </div>
        <div class="env-banner-details">
          <strong>S3 Bucket:</strong> <span id="env-bucket">-</span>
        </div>
      </div>
      <div class="env-banner-details">
        Last updated: <span id="env-timestamp">-</span>
      </div>
    </div>
    
    <header class="page-header">
      <div class="page-header-left">
        <h1>üì¶ Woo Product Updater</h1>
        <p>Upload CSV files, configure mappings, and sync products with WooCommerce</p>
      </div>
      <div class="page-header-right">
        <a href="/admin/queues" target="_blank" class="btn btn-secondary" id="bull-board-link">üìä Bull Dashboard</a>
        <button type="button" class="btn btn-secondary" onclick="loadAndRenderFiles()">üîÑ Refresh</button>
        <button type="button" class="btn btn-success" id="start-processing-btn" onclick="triggerProcessing()">‚ñ∂Ô∏è Start Processing</button>
      </div>
    </header>
    
    <div class="main-layout">
      <div class="main-content">
        <!-- Upload Card -->
        <div class="card">
          <div class="card-header"><h2>üì§ Upload CSV File</h2></div>
          <form id="upload-form">
            <div class="form-group">
              <label class="form-label" for="folder">Target Folder (optional)</label>
              <input type="text" id="folder" name="folder" class="form-input" placeholder="e.g., vendor-uploads/november" />
              <p class="form-help">Organize files into folders in S3.</p>
            </div>
            <div class="form-group">
              <label class="form-label" for="file">CSV File</label>
              <input type="file" id="file" name="file" accept=".csv" class="form-input" required />
            </div>
            <button type="submit" class="btn btn-primary">üì§ Upload to S3</button>
          </form>
        </div>
        
        <!-- Files Card -->
        <div class="card">
          <div class="card-header">
            <h2>üìÅ CSV Files</h2>
            <button type="button" class="btn btn-xs btn-secondary" onclick="loadAndRenderFiles()">üîÑ</button>
          </div>
          <div class="file-list" id="file-list">
            <p class="text-muted">Loading files...</p>
          </div>
        </div>
      </div>
      
      <div class="sidebar">
        <!-- Admin Panel -->
        <div class="admin-panel">
          <div class="admin-panel-header">
            <div class="admin-panel-title">üîß Admin Controls</div>
          </div>
          <div class="admin-panel-actions">
            <button class="admin-btn admin-btn-yellow" id="btn-restart" onclick="restartWorkers()">üîÑ Restart</button>
            <button class="admin-btn admin-btn-orange" id="btn-flush" onclick="flushRedis()">üóëÔ∏è Flush Redis</button>
            <button class="admin-btn admin-btn-red" id="btn-reset" onclick="fullReset()">‚ö†Ô∏è Full Reset</button>
            <button class="admin-btn admin-btn-purple" id="btn-clear-logs" onclick="clearLogs()">üìã Clear Logs</button>
          </div>
          <div class="admin-status" id="admin-status">Ready</div>
        </div>
        
        <!-- Log Viewer -->
        <div class="log-viewer">
          <div class="log-viewer-header">
            <div class="log-viewer-title">
              üìã Live Logs
              <span class="log-status" id="log-status">
                <span class="log-status-dot" id="log-status-dot"></span>
                <span id="log-status-text">Live</span>
              </span>
            </div>
            <div class="log-viewer-controls">
              <select id="log-type" class="form-select" style="width: auto; padding: 4px 8px; font-size: 11px;">
                <option value="info">Info Logs</option>
                <option value="error">Error Logs</option>
              </select>
              <select id="log-env-filter" class="form-select" style="width: auto; padding: 4px 8px; font-size: 11px;">
                <option value="">All Environments</option>
                <option value="PROD">Production Only</option>
                <option value="STAGING">Staging Only</option>
                <option value="DEV">Development Only</option>
              </select>
              <button type="button" class="btn btn-xs btn-secondary" onclick="toggleLogPause()" id="btn-pause-logs">‚è∏Ô∏è</button>
              <button type="button" class="btn btn-xs btn-secondary" onclick="clearLogViewer()">üóëÔ∏è</button>
              <button type="button" class="btn btn-xs btn-secondary" onclick="fetchLogs()">üîÑ</button>
            </div>
          </div>
          <div class="log-viewer-body" id="log-viewer-body"><div class="log-line">Waiting for logs...</div></div>
        </div>
        
        <!-- System Status -->
        <div class="card mt-4">
          <div class="card-header">
            <h2>‚öôÔ∏è System Status</h2>
            <button type="button" class="btn btn-xs btn-secondary" onclick="fetchSystemStatus()">üîÑ</button>
          </div>
          <div id="system-status">
            <div class="stats-grid">
              <div class="stat-item"><div class="stat-value" id="status-redis-keys">-</div><div class="stat-label">Redis Keys</div></div>
              <div class="stat-item"><div class="stat-value" id="status-checkpoint-files">-</div><div class="stat-label">Checkpoints</div></div>
              <div class="stat-item"><div class="stat-value" id="status-files-ready">-</div><div class="stat-label">Ready Files</div></div>
              <div class="stat-item"><div class="stat-value" id="status-files-processing">-</div><div class="stat-label">Processing</div></div>
              <div class="stat-item"><div class="stat-value" id="status-files-completed">-</div><div class="stat-label">Completed</div></div>
              <div class="stat-item"><div class="stat-value" id="status-archived-logs">-</div><div class="stat-label">Archived Logs</div></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal Template -->
  <div class="modal-overlay hidden" id="modal-overlay">
    <div class="modal">
      <div class="modal-title" id="modal-title">Confirm</div>
      <div class="modal-body" id="modal-body">Are you sure?</div>
      <div class="modal-actions">
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn" id="modal-confirm-btn">Confirm</button>
      </div>
    </div>
  </div>

  <script>
    // ==========================================================================
    // CONFIGURATION
    // ==========================================================================
    const CONFIG = {
      API: {
        MAPPINGS: '/api/csv-mappings',
        UPLOAD: '/api/upload',
        LOGS: '/api/logs',
        SYSTEM_STATUS: '/api/system-status',
        ENVIRONMENT: '/api/environment',
        PROGRESS: '/api/progress',
        TRIGGER: '/api/trigger-processing',
        ADMIN: '/api/admin',
      },
      REFRESH_INTERVAL: 5000,
      LOG_REFRESH_INTERVAL: 3000,
    };
    
    let logPaused = false;
    let currentEnv = { mode: 'unknown', label: 'UNKNOWN', bucket: '' };
    
    // ==========================================================================
    // ENVIRONMENT
    // ==========================================================================
    async function fetchEnvironment() {
      try {
        const res = await fetch(CONFIG.API.ENVIRONMENT);
        const data = await res.json();
        currentEnv = data;
        updateEnvironmentUI(data);
      } catch (err) {
        console.error('Failed to fetch environment:', err);
      }
    }
    
    function updateEnvironmentUI(env) {
      const banner = document.getElementById('env-banner');
      const badge = document.getElementById('env-badge');
      const label = document.getElementById('env-label');
      const bucket = document.getElementById('env-bucket');
      const timestamp = document.getElementById('env-timestamp');
      
      // Remove all env classes
      banner.classList.remove('prod', 'staging', 'dev');
      badge.classList.remove('prod', 'staging', 'dev');
      
      // Add appropriate class
      const envClass = env.label === 'PROD' ? 'prod' : env.label === 'STAGING' ? 'staging' : 'dev';
      banner.classList.add(envClass);
      badge.classList.add(envClass);
      
      label.textContent = env.label;
      bucket.textContent = env.bucket || '-';
      timestamp.textContent = new Date(env.timestamp).toLocaleTimeString();
      
      // Update page title
      document.title = `[${env.label}] Woo Product Updater`;
    }
    
    // ==========================================================================
    // TOAST & MODAL
    // ==========================================================================
    function showToast(message, type = 'info') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `<span>${message}</span>`;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 4000);
    }
    
    function showModal(title, body, onConfirm, confirmText = 'Confirm', confirmClass = 'btn-primary') {
      document.getElementById('modal-title').textContent = title;
      document.getElementById('modal-body').textContent = body;
      const confirmBtn = document.getElementById('modal-confirm-btn');
      confirmBtn.textContent = confirmText;
      confirmBtn.className = `btn ${confirmClass}`;
      confirmBtn.onclick = () => { closeModal(); onConfirm(); };
      document.getElementById('modal-overlay').classList.remove('hidden');
    }
    
    function closeModal() {
      document.getElementById('modal-overlay').classList.add('hidden');
    }
    
    // ==========================================================================
    // API HELPERS
    // ==========================================================================
    async function apiRequest(url, options = {}) {
      const res = await fetch(url, options);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }
    
    function setLoading(btn, loading) {
      if (loading) {
        btn.classList.add('loading');
        btn.disabled = true;
      } else {
        btn.classList.remove('loading');
        btn.disabled = false;
      }
    }
    
    function setAdminStatus(msg) {
      document.getElementById('admin-status').textContent = msg;
    }
    
    // ==========================================================================
    // FILES
    // ==========================================================================
    async function loadAndRenderFiles() {
      try {
        const data = await apiRequest(CONFIG.API.MAPPINGS);
        const files = data.files || [];
        renderFiles(files);
      } catch (err) {
        console.error('Failed to load files:', err);
        showToast('Failed to load files', 'error');
      }
    }
    
    function renderFiles(files) {
      const container = document.getElementById('file-list');
      if (!files.length) {
        container.innerHTML = '<p class="text-muted" style="text-align: center; padding: 20px;">No files uploaded yet</p>';
        return;
      }
      
      container.innerHTML = files.map(file => `
        <div class="file-item">
          <div class="file-info">
            <div class="file-name">${file.fileKey}</div>
            <div class="file-status">
              <span class="status-badge status-${file.status || 'pending'}">${file.status || 'pending'}</span>
            </div>
          </div>
          <div class="file-actions">
            <button class="btn btn-xs btn-primary" onclick="setFileStatus('${file.fileKey}', 'ready')">‚úÖ Ready</button>
            <button class="btn btn-xs btn-danger" onclick="deleteFile('${file.fileKey}')">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');
    }
    
    async function setFileStatus(fileKey, status) {
      try {
        await apiRequest(CONFIG.API.MAPPINGS, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ fileKey, status, mapping: {} }),
        });
        showToast(`File marked as ${status}`, 'success');
        loadAndRenderFiles();
      } catch (err) {
        showToast('Failed to update file status', 'error');
      }
    }
    
    async function deleteFile(fileKey) {
      showModal('Delete File', `Are you sure you want to delete ${fileKey}?`, async () => {
        try {
          await apiRequest(`${CONFIG.API.MAPPINGS}/${encodeURIComponent(fileKey)}`, { method: 'DELETE' });
          showToast('File deleted', 'success');
          loadAndRenderFiles();
        } catch (err) {
          showToast('Failed to delete file', 'error');
        }
      }, 'Delete', 'btn-danger');
    }
    
    // ==========================================================================
    // UPLOAD
    // ==========================================================================
    document.getElementById('upload-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      
      try {
        const res = await fetch(CONFIG.API.UPLOAD, { method: 'POST', body: formData });
        const data = await res.json();
        if (data.success) {
          showToast(`Uploaded: ${data.fileKey}`, 'success');
          form.reset();
          loadAndRenderFiles();
        } else {
          throw new Error(data.error || 'Upload failed');
        }
      } catch (err) {
        showToast('Upload failed: ' + err.message, 'error');
      }
    });
    
    // ==========================================================================
    // PROCESSING
    // ==========================================================================
    async function triggerProcessing() {
      const btn = document.getElementById('start-processing-btn');
      setLoading(btn, true);
      try {
        await apiRequest(CONFIG.API.TRIGGER, { method: 'POST' });
        showToast('Processing started', 'success');
      } catch (err) {
        showToast('Failed to start processing', 'error');
      } finally {
        setLoading(btn, false);
      }
    }
    
    // ==========================================================================
    // ADMIN ACTIONS
    // ==========================================================================
    async function restartWorkers() {
      const btn = document.getElementById('btn-restart');
      setLoading(btn, true);
      setAdminStatus('Restarting workers...');
      try {
        const result = await apiRequest(`${CONFIG.API.ADMIN}/restart-workers`, { method: 'POST' });
        showToast(result.message || 'Workers restarted', 'success');
        setAdminStatus('Workers restarted at ' + new Date().toLocaleTimeString());
      } catch (err) {
        showToast('Restart failed: ' + err.message, 'error');
        setAdminStatus('Restart failed');
      } finally {
        setLoading(btn, false);
      }
    }
    
    async function flushRedis() {
      showModal('Flush Redis', 'This will clear all Redis data including progress. Continue?', async () => {
        const btn = document.getElementById('btn-flush');
        setLoading(btn, true);
        setAdminStatus('Flushing Redis...');
        try {
          const result = await apiRequest(`${CONFIG.API.ADMIN}/flush-redis`, { method: 'POST' });
          showToast(result.message || 'Redis flushed', 'success');
          setAdminStatus('Redis flushed at ' + new Date().toLocaleTimeString());
          fetchSystemStatus();
        } catch (err) {
          showToast('Flush failed: ' + err.message, 'error');
          setAdminStatus('Flush failed');
        } finally {
          setLoading(btn, false);
        }
      }, 'Flush Redis', 'btn-warning');
    }
    
    async function fullReset() {
      showModal('‚ö†Ô∏è Full System Reset', 'This will stop workers, flush Redis, and clear all progress. This cannot be undone!', async () => {
        const btn = document.getElementById('btn-reset');
        setLoading(btn, true);
        setAdminStatus('Performing full reset...');
        showToast('Full reset in progress. This may take 10-15 seconds.', 'warning');
        try {
          const result = await apiRequest(`${CONFIG.API.ADMIN}/full-reset`, { method: 'POST' });
          showToast(result.message || 'Full reset completed', 'success');
          setAdminStatus('Full reset completed at ' + new Date().toLocaleTimeString());
          setTimeout(() => {
            fetchSystemStatus();
            loadAndRenderFiles();
            fetchLogs();
          }, 5000);
        } catch (err) {
          showToast('Reset failed: ' + err.message, 'error');
          setAdminStatus('Reset failed');
        } finally {
          setLoading(btn, false);
        }
      }, 'Yes, Reset Everything', 'btn-danger');
    }
    
    async function clearLogs() {
      const envFilter = document.getElementById('log-env-filter').value;
      const envOnly = !!envFilter;
      const message = envOnly 
        ? `This will clear logs for ${envFilter} environment only. Continue?`
        : 'This will clear ALL log files. Continue?';
      
      showModal('üìã Clear Logs', message, async () => {
        const btn = document.getElementById('btn-clear-logs');
        setLoading(btn, true);
        try {
          const result = await apiRequest(`${CONFIG.API.ADMIN}/clear-logs`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ envOnly }),
          });
          showToast(result.message || 'Logs cleared', 'success');
          clearLogViewer();
        } catch (err) {
          showToast('Failed to clear logs: ' + err.message, 'error');
        } finally {
          setLoading(btn, false);
        }
      }, 'Clear Logs', 'btn-purple');
    }
    
    // ==========================================================================
    // LOGS
    // ==========================================================================
    async function fetchLogs() {
      if (logPaused) return;
      try {
        const type = document.getElementById('log-type').value;
        const envFilter = document.getElementById('log-env-filter').value;
        let url = `${CONFIG.API.LOGS}?lines=100&type=${type}`;
        if (envFilter) url += `&env=${envFilter}`;
        
        const data = await apiRequest(url);
        if (data.logs && data.logs.length > 0) {
          renderLogs(data.logs);
        }
      } catch (err) {
        console.error('Failed to fetch logs:', err);
      }
    }
    
    function renderLogs(logs) {
      const container = document.getElementById('log-viewer-body');
      container.innerHTML = logs.map(log => {
        let lineClass = 'log-line';
        if (log.includes('‚ùå') || log.includes('Error') || log.includes('error') || log.includes('ERROR')) lineClass += ' log-error';
        else if (log.includes('‚úÖ') || log.includes('Success') || log.includes('completed')) lineClass += ' log-success';
        else if (log.includes('‚ö†Ô∏è') || log.includes('Warning') || log.includes('Skipping')) lineClass += ' log-warning';
        else if (log.includes('üöÄ') || log.includes('Processing') || log.includes('üîÑ')) lineClass += ' log-info';
        
        // Highlight environment tags
        let formattedLog = log
          .replace(/\[PROD\]/g, '<span class="env-tag prod">[PROD]</span>')
          .replace(/\[STAGING\]/g, '<span class="env-tag staging">[STAGING]</span>')
          .replace(/\[DEV\]/g, '<span class="env-tag dev">[DEV]</span>');
        
        return `<div class="${lineClass}">${formattedLog}</div>`;
      }).join('');
      container.scrollTop = container.scrollHeight;
    }
    
    function toggleLogPause() {
      logPaused = !logPaused;
      const dot = document.getElementById('log-status-dot');
      const text = document.getElementById('log-status-text');
      const btn = document.getElementById('btn-pause-logs');
      
      if (logPaused) {
        dot.classList.add('paused');
        text.textContent = 'Paused';
        btn.textContent = '‚ñ∂Ô∏è';
      } else {
        dot.classList.remove('paused');
        text.textContent = 'Live';
        btn.textContent = '‚è∏Ô∏è';
        fetchLogs();
      }
    }
    
    function clearLogViewer() {
      document.getElementById('log-viewer-body').innerHTML = '<div class="log-line">Log viewer cleared</div>';
    }
    
    // ==========================================================================
    // SYSTEM STATUS
    // ==========================================================================
    async function fetchSystemStatus() {
      try {
        const data = await apiRequest(CONFIG.API.SYSTEM_STATUS);
        document.getElementById('status-redis-keys').textContent = data.redis?.keyCount || 0;
        document.getElementById('status-checkpoint-files').textContent = data.checkpoint ? '1' : '0';
        document.getElementById('status-files-ready').textContent = data.files?.ready || 0;
        document.getElementById('status-files-processing').textContent = data.files?.processing || 0;
        document.getElementById('status-files-completed').textContent = data.files?.completed || 0;
        document.getElementById('status-archived-logs').textContent = data.logs?.archivedCount || 0;
      } catch (err) {
        console.error('Failed to fetch system status:', err);
      }
    }
    
    // ==========================================================================
    // INITIALIZATION
    // ==========================================================================
    document.addEventListener('DOMContentLoaded', () => {
      fetchEnvironment();
      loadAndRenderFiles();
      fetchSystemStatus();
      fetchLogs();
      
      // Set up refresh intervals
      setInterval(fetchLogs, CONFIG.LOG_REFRESH_INTERVAL);
      setInterval(fetchSystemStatus, CONFIG.REFRESH_INTERVAL);
      setInterval(fetchEnvironment, 30000); // Refresh environment every 30s
      
      // Trigger log refresh on filter change
      document.getElementById('log-type').addEventListener('change', fetchLogs);
      document.getElementById('log-env-filter').addEventListener('change', fetchLogs);
    });
  </script>
</body>
</html>